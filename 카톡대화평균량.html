<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>톡 대화 통계 분석기</title>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 2em; }
    #dropZone {
      padding: 1em;
      border: 2px dashed #888;
      background: #fff;
      text-align: center;
      color: #666;
      border-radius: 8px;
      margin-top: 2em;
      margin-bottom: 2em;
    }
    section {
      background: white;
      padding: 1em;
      border-radius: 8px;
      margin: 1em 0;
      box-shadow: 0 0 5px #ccc;
    }
    li { margin: 0.3em 0; }
    h3 { margin-bottom: 0.5em; }
    .summary, #memberList { font-weight: bold; margin-top: 2em; }
  </style>
</head>
<body>
  <h2>📊 톡 대화 통계 + 순위 분석기</h2>

  <p>1️⃣ 대화 기록 파일 선택:</p>
  <input type="file" id="chatFile" accept=".txt" /><br><br>

  <p>2️⃣ (선택) 인원.txt 파일을 드래그해서 아래 영역에 올려주세요</p>
  <div id="dropZone">👥 인원.txt 파일 드롭 (선택)</div>

  <div id="memberList"></div>
  <div id="summary" class="summary"></div>
  <div id="stats"></div>

  <script>
    let memberList = null;
    let chatMessages = [];

    document.getElementById("dropZone").addEventListener("dragover", e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "copy";
      e.currentTarget.style.background = "#e0f7fa";
    });

    document.getElementById("dropZone").addEventListener("dragleave", e => {
      e.currentTarget.style.background = "#fff";
    });

    document.getElementById("dropZone").addEventListener("drop", async e => {
      e.preventDefault();
      e.currentTarget.style.background = "#fff";

      const file = Array.from(e.dataTransfer.files).find(f => f.name === "인원.txt");
      if (!file) return alert("⚠️ 인원.txt 파일을 드롭해주세요.");

      const text = await file.text();
      memberList = text.split("\n").map(v => v.trim()).filter(Boolean);

      // 현재 메시지 기반으로 인원별 메시지 수 계산
      const counts = {};
      memberList.forEach(name => {
        counts[name] = chatMessages.filter(m => m.nickname === name).length;
      });

      document.getElementById("memberList").innerHTML =
        "<p>📌 필터링할 인원 목록 (총 대화량 기준):</p><ul>" +
        memberList.map(name =>
          `<li>${name} (${counts[name] || 0}개)</li>`
        ).join("") +
        "</ul>";

      if (chatMessages.length > 0) processAndRender();
    });

    document.getElementById("chatFile").addEventListener("change", async function() {
      const file = this.files[0];
      if (!file) return;

      const text = await file.text();
      const lines = text.split("\n");
      chatMessages = [];
      let currentDate = null;

      for (const line of lines) {
        const dateMatch = line.match(/-+ (\d{4})년 (\d{1,2})월 (\d{1,2})일/);
        const msgMatch = line.match(/\[(.+?)\] \[(오전|오후) (\d{1,2}):(\d{2})\] (.+)/);

        if (dateMatch) {
          const [_, y, m, d] = dateMatch;
          currentDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        } else if (msgMatch && currentDate) {
          const [, nickname] = msgMatch;
          chatMessages.push({ date: currentDate, nickname });
        }
      }

      processAndRender();
    });

    function processAndRender() {
      const filteredMessages = memberList
        ? chatMessages.filter(msg => memberList.includes(msg.nickname))
        : [...chatMessages];

      const monthlyStats = {};
      const totalStats = {};
      const overallTotal = filteredMessages.length;

      filteredMessages.forEach(({ date, nickname }) => {
        const month = date.slice(0, 7);
        if (!monthlyStats[month]) monthlyStats[month] = {};
        if (!monthlyStats[month][nickname]) monthlyStats[month][nickname] = 0;
        monthlyStats[month][nickname]++;
        if (!totalStats[nickname]) totalStats[nickname] = 0;
        totalStats[nickname]++;
      });

      const summary = document.getElementById("summary");
      summary.innerHTML = `<p>총 대화량: <strong>${overallTotal}</strong>개 (${memberList ? "필터링된 인원 기준" : "전체 인원 기준"})</p><ul>` +
        getRankedList(totalStats).map(({ rank, nickname, count }) => {
          const percent = ((count / overallTotal) * 100).toFixed(1);
          return `<li><strong>${rank}위</strong> ${nickname}: ${count}개 (${percent}%)</li>`;
        }).join("") + "</ul>";

      const stats = document.getElementById("stats");
      stats.innerHTML = "";
      Object.entries(monthlyStats).forEach(([month, data]) => {
        const monthTotal = Object.values(data).reduce((a, b) => a + b, 0);
        const monthPercent = ((monthTotal / overallTotal) * 100).toFixed(1);
        const ranked = getRankedList(data);
        const section = document.createElement("section");
        section.innerHTML = `<h3>${month} ▶ 총 ${monthTotal}개 (${monthPercent}%)</h3><ul>` +
          ranked.map(({ rank, nickname, count }) => {
            const percent = ((count / monthTotal) * 100).toFixed(1);
            return `<li><strong>${rank}위</strong> ${nickname}: ${count}개 (${percent}%)</li>`;
          }).join("") + "</ul>";
        stats.appendChild(section);
      });
    }

    function getRankedList(statsObj) {
      const entries = Object.entries(statsObj).sort((a, b) => b[1] - a[1]);
      const ranked = [];
      let currentRank = 1;
      let prevCount = null;
      entries.forEach(([nick, count], i) => {
        if (count !== prevCount) currentRank = i + 1;
        ranked.push({ rank: currentRank, nickname: nick, count });
        prevCount = count;
      });
      return ranked;
    }
  </script>
</body>
</html>