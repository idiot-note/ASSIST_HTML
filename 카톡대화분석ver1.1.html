<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í†¡ ëŒ€í™” í†µê³„ ë¶„ì„ê¸°</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 2em;
    }
    h2 { margin-bottom: 0.5em; }
    #dropZone {
      border: 2px dashed gray;
      padding: 1em;
      margin: 1em 0;
      border-radius: 8px;
      background: #fff;
      text-align: center;
    }
    section {
      background: #fff;
      padding: 1em;
      border-radius: 8px;
      margin: 1em 0;
      box-shadow: 0 0 5px #ccc;
    }
    li { margin: 0.3em 0; }
    h3, h4 { margin-bottom: 0.5em; }
    .summary, .section-title {
      font-weight: bold;
      margin-top: 2em;
    }
  </style>
</head>
<body>
  <h2>ğŸ“Š í†¡ ëŒ€í™” í†µê³„ + ì…í‡´ì¥ ë¶„ì„ê¸°</h2>

  <p>1ï¸âƒ£ ëŒ€í™”ê¸°ë¡ íŒŒì¼ ì„ íƒ:</p>
  <input type="file" id="chatFile" accept=".txt" /><br><br>

  <p>2ï¸âƒ£ (ì„ íƒ) ì¸ì›.txt íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ì•„ë˜ ì˜ì—­ì— ì˜¬ë ¤ì£¼ì„¸ìš”</p>
  <div id="dropZone">ğŸ‘¥ ì¸ì›.txt íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­</div>

  <div id="memberList"></div>
  <div id="newMembers" class="section-title"></div>
  <div id="leftMembers" class="section-title"></div>
  <div id="summary" class="summary"></div>
  <div id="monthlyStats"></div>
  <div id="monthlyJoins" class="section-title"></div>
  <script>
    let chatMessages = [];
    let memberList = null;

    document.getElementById("dropZone").addEventListener("dragover", e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "copy";
      e.currentTarget.style.background = "#e0f7fa";
    });

    document.getElementById("dropZone").addEventListener("dragleave", e => {
      e.currentTarget.style.background = "#fff";
    });

    document.getElementById("dropZone").addEventListener("drop", async e => {
      e.preventDefault();
      e.currentTarget.style.background = "#fff";
      const file = [...e.dataTransfer.files].find(f => f.name === "ì¸ì›.txt");
      if (!file) return alert("âš ï¸ ì¸ì›.txt íŒŒì¼ì„ ë“œë¡­í•´ì£¼ì„¸ìš”.");
      const text = await file.text();
      memberList = text.split("\n").map(v => v.trim()).filter(Boolean);
      document.getElementById("memberList").innerHTML =
        "<p>ğŸ“Œ ì¸ì›.txt ê¸°ì¤€ ì¸ì›:</p><ul>" +
        memberList.map(n => `<li>${n}</li>`).join("") + "</ul>";
      if (chatMessages.length > 0) process();
    });

    document.getElementById("chatFile").addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;
      const text = await file.text();
      chatMessages = [];
      const lines = text.split("\n");
      let currentDate = null;

      for (const line of lines) {
        const dateMatch = line.match(/-+ (\d{4})ë…„ (\d{1,2})ì›” (\d{1,2})ì¼/);
        const msgMatch = line.match(/\[(.+?)\] \[(ì˜¤ì „|ì˜¤í›„) (\d{1,2}):(\d{2})\] (.+)/);
        if (dateMatch) {
          const [_, y, m, d] = dateMatch;
          currentDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        } else if (msgMatch && currentDate) {
          const [, nickname, , , , message] = msgMatch;
          chatMessages.push({ date: currentDate, nickname, message });
        }else if (currentDate) {
    // âœ… ëŒ€ê´„í˜¸ ì—†ëŠ” ì‹œìŠ¤í…œ ë©”ì‹œì§€ë„ ìˆ˜ì§‘
    chatMessages.push({ date: currentDate, nickname: null, message: line.trim() });
  }
      }

      process();
    });

    function process() {
    const joined = {}, left = {}, monthlyStats = {}, monthlyMoves = {};
    const newMembers = [], leftMembers = [], totalStats = {};

    const filteredMessages = chatMessages.filter(({ nickname }) =>
      nickname !== null && (!memberList || memberList.includes(nickname))
    );
    const overallTotal = filteredMessages.length;

    filteredMessages.forEach(({ date, nickname }) => {
      const month = date.slice(0, 7);
      if (!monthlyStats[month]) monthlyStats[month] = {};
      if (!monthlyStats[month][nickname]) monthlyStats[month][nickname] = 0;
      monthlyStats[month][nickname]++;
      if (!totalStats[nickname]) totalStats[nickname] = 0;
      totalStats[nickname]++;
    });

    // ì •ê·œì‹ ê¸°ë°˜ ì…í‡´ì¥ ê°ì§€
    chatMessages.forEach(({ date, message }) => {
      const month = date.slice(0, 7);
      if (!monthlyMoves[month]) monthlyMoves[month] = { joined: new Set(), left: new Set() };

      const joinMatch = message.match(/^(.+?)ë‹˜[ì´ì„] (ë“¤ì–´ì™”ìŠµë‹ˆë‹¤|ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤)\.$/);
      if (joinMatch) {
        const name = joinMatch[1].trim();
        joined[name] = (joined[name] || 0) + 1;
        monthlyMoves[month].joined.add(name);
      }

      const leaveMatch = message.match(/^(.+?)ë‹˜[ì´ì„] (ë‚˜ê°”ìŠµë‹ˆë‹¤|ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤)\.$/);
      if (leaveMatch) {
        const name = leaveMatch[1].trim();
        left[name] = (left[name] || 0) + 1;
        monthlyMoves[month].left.add(name);
      }
    });

    const allNames = new Set([
      ...Object.keys(joined),
      ...Object.keys(left),
      ...(memberList || [])
    ]);

    allNames.forEach(name => {
      const join = joined[name] || 0;
      const leave = left[name] || 0;

      if (join === 0 && leave > 0) {
        leftMembers.push(name);
      } else if (join > 0 && join > leave) {
        if (!memberList || !memberList.includes(name)) {
          newMembers.push(name);
        }
      }
    });

    document.getElementById("newMembers").innerHTML =
      "<p>âœ… í˜„ì¬ ì°¸ì—¬ ì¤‘ì¸ ì‹ ê·œ ìœ ì… ë©¤ë²„:</p><ul>" +
      newMembers.map(n => `<li>${n}</li>`).join("") + "</ul>";

    document.getElementById("leftMembers").innerHTML = memberList
      ? "<p>ğŸšª ë‚˜ê°„ ì¸ì› (ì¸ì›.txt ê¸°ì¤€ ë˜ëŠ” ê°•í‡´ì):</p><ul>" +
        leftMembers.map(n => `<li>${n}</li>`).join("") + "</ul>"
      : "";

    const summary = document.getElementById("summary");
    summary.innerHTML =
      `<p>ğŸ’¬ ì´ ëŒ€í™”ëŸ‰: <strong>${overallTotal}</strong>ê°œ (${memberList ? "ì¸ì›.txt ê¸°ì¤€" : "ì „ì²´ ê¸°ì¤€"})</p><ul>` +
      rankList(totalStats).map(({ rank, nickname, count }) => {
        const percent = ((count / overallTotal) * 100).toFixed(1);
        return `<li><strong>${rank}ìœ„</strong> ${nickname}: ${count}ê°œ (${percent}%)</li>`;
      }).join("") + "</ul>";

    // âœ… ëŒ€í™” ê¸°ë¡ì´ ì—†ëŠ” ì¸ì› í‘œì‹œ
    const silentMembers = memberList
      ? memberList.filter(name => !Object.keys(totalStats).includes(name))
      : [];

    if (silentMembers.length > 0) {
      const silentSection = document.createElement("div");
      silentSection.className = "section-title";
      silentSection.innerHTML =
        "<p>ğŸ¤ ëŒ€í™” ê¸°ë¡ì´ ì—†ëŠ” ì¸ì›:</p><ul>" +
        silentMembers.map(n => `<li>${n}</li>`).join("") + "</ul>";
      summary.appendChild(silentSection);
    }

    const stats = document.getElementById("monthlyStats");
    stats.innerHTML = "<h3>ğŸ“ˆ ì›”ë³„ ëŒ€í™”ëŸ‰ ìˆœìœ„</h3>" +
      Object.entries(monthlyStats).sort().map(([month, data]) => {
        const monthTotal = Object.values(data).reduce((a, b) => a + b, 0);
        const ranked = rankList(data);
        return `<section><h4>${month} â–¶ ì´ ${monthTotal}ê°œ</h4><ul>` +
          ranked.map(({ rank, nickname, count }) => {
            const percent = ((count / monthTotal) * 100).toFixed(1);
            return `<li><strong>${rank}ìœ„</strong> ${nickname}: ${count}ê°œ (${percent}%)</li>`;
          }).join("") + "</ul></section>";
      }).join("");

    const monthlyEl = document.getElementById("monthlyJoins");
    monthlyEl.innerHTML = "<h3>ğŸ“† ì›”ë³„ ì…í‡´ì¥ ë‚´ì—­</h3>" +
      Object.entries(monthlyMoves).sort().map(([month, data]) => {
        const joinedList = [...data.joined].sort().join(", ") || "ì—†ìŒ";
        const leftList = [...data.left].sort().join(", ") || "ì—†ìŒ";
        return `<section><h4>${month}</h4><ul>
            <li>ğŸ“¥ ì‹ ê·œ ìœ ì…: ${joinedList}</li>
            <li>ğŸšª ë‚˜ê°„ ì¸ì›: ${leftList}</li>
          </ul></section>`;
      }).join("");
  }

    function rankList(obj) {
      const entries = Object.entries(obj).sort((a, b) => b[1] - a[1]);
      const ranked = [];
      let currentRank = 1;
      let prevCount = null;
      entries.forEach(([nickname, count], i) => {
        if (count !== prevCount) currentRank = i + 1;
        ranked.push({ rank: currentRank, nickname, count });
        prevCount = count;
      });
      return ranked;
    }
  </script>
</body>
</html>